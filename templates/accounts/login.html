<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>login</title>
</head>
<body>
    <div class="container">
        <!-- 사용자명과 비밀번호를 입력하는 input 요소들 -->
        <label>username:</label><input id="username" type="id" placeholder="id를 입력해주세요." required><br>
        <label>password:</label><input id="password" type="password" placeholder="password 입력해주세요." required><br>
        <!-- 로그인 버튼 -->
        <button id="button" type="submit">제출</button>
    </div>

    <script>
        // 로그인 버튼 요소를 변수에 할당
        const loginbutton = document.querySelector("#button");

        // 로그인 버튼에 클릭 이벤트 리스너 추가
        loginbutton.addEventListener("click", login);

        // 로그인 함수
        function login() {
            // 사용자명과 비밀번호를 가져옴
            const username = document.querySelector("#username").value;
            const password = document.querySelector("#password").value;

            // 로그인 요청을 위한 request 객체 생성
            const request = {
                username: username,
                password: password
            };

            // 서버로 로그인 요청을 보냄
            fetch("http://127.0.0.1:8000/accounts/login/", {
                method: "POST", // POST 메서드로 요청
                headers: {
                    "Content-Type": "application/json" // JSON 형식의 데이터 전송
                },
                body: JSON.stringify(request) // 요청 데이터를 JSON 형식으로 변환하여 전송
            })
            .then(response => {
                if (response.ok) {
                    // 로그인이 성공한 경우
                    console.log("로그인에 성공했습니다.");
                    // 응답으로부터 액세스 토큰을 추출하여 사용자 정보 요청 함수 호출
                    response.json().then(data => {
                        const accessToken = data.access_token;
                        console.log("액세스 토큰:", accessToken); // 토큰 값을 console에 출력
                        // 로그인할 때 사용한 사용자명을 가져와서 fetchUserInfo 함수에 전달
                        const username = document.querySelector("#username").value;
                        fetchUserInfo(accessToken, username);
                    });
                } else {
                    // 로그인이 실패한 경우
                    console.log("로그인에 실패했습니다.");
                }
            })

            .catch(error => {
                // 오류 발생시
                console.error("오류 발생:", error);
            });

        }

        // 사용자 정보 요청 함수
        function fetchUserInfo(accessToken, username) {
            // 액세스 토큰을 사용하여 사용자 정보 요청을 보냄
            fetch(`http://127.0.0.1:8000/accounts/userinfo?username=${username}`, {
                method: "GET", // GET 메서드로 요청
                headers: {
                    "Authorization": `Bearer ${accessToken}` // 헤더에 액세스 토큰 포함
                },
            })
            .then(response => {
                if (response.ok) {
                    // 사용자 정보 요청이 성공한 경우
                    return response.json(); // JSON 형식으로 응답을 파싱하여 반환
                } else {
                    // 사용자 정보 요청이 실패한 경우
                    throw new Error('사용자 정보를 가져오는데 실패했습니다.');
                }
            })
            .then(data => {
                // 응답으로부터 받은 사용자 정보를 처리
                console.log("사용자 username:", username); // 받아온 username을 출력
            })
            .catch(error => {
                // 오류 발생시
                console.error("사용자 정보를 가져오는데 오류 발생:", error);
            });
        }
    </script>
</body>
</html>
